---
layout: post
title: spi总线
categories: [spi]
description: 
keywords: 
topmost: false
---

* TOC
{:toc}

## 简介

SPI（Serial Peripheral Interface，串行外设接口）是一种用于芯片通信的串行同步传输总线协议。SPI最初由Motorola在2000年提出，但不同半导体公司的实施细节可能有所不同，这些区别体现在寄存器设置、信号定义、数据格式等。业界没有统一的SPI标准，具体应用需要参考特定器件手册。

* SPI允许数据一位一位的传送，甚至允许暂停，因为SCK时钟线由主控设备控制，当没有时钟跳变时，从设备不采集或传送数据。也就是说，主设备通过对SCK时钟线的控制可以完成对通讯的控制。

* 支持全双工通信，每个从设备需要独立的使能信号。

* Push-Pull驱动性能相比Open Drain信号完整性更好，支持高速应用（100MHz以上）。

* 协议支持字长不限于8bits，可根据应用特点灵活选择消息字长。

* 相比I2C和SMbus节省上拉电阻，不需要仲裁机制。

* 没有寻址机制，只能靠设备片选选择不同从设备。所以没有数据流控制和应答机制。

* SPI没有规定最大传输速率。

**Dual SPI**是针对SPI Flash而言，不是针对所有SPI外设。对于SPI Flash，全双工并不常用，因此修改了mosi和miso的用法，让它们工作在半双工，用以加倍数据传输。也就是对于Dual SPI Flash，可以发送一个命令字节进入dual mode，这样mosi变成SIO0（serial io 0），mosi变成SIO1（serial io 1），这样一个时钟周期内就能传输2个bit数据。

**Qual SPI**也是针对SPI Flash，Qual SPI 在Dual SPI基础上增加了两根I/O线（SIO2,SIO3），目的是一个时钟内能传输4个bit数据。

## 信号定义

**MOSI**：主设备数据输出，从设备数据输入。

**MISO**：主设备数据输入，从设备数据输出。

**SCLK**：时钟信号，由主设备产生。

**CS/SS**：片选，从设备使能信号，由主设备控制。

SPI总线定义两个及以上设备间的数据传输，提供时钟的设备为主设备(Master)，接收时钟的设备为从设备(Slave)。

片选信号SS通常低电平有效。SPI数据传输原理是基于主从设备内部移位寄存器的数据交换。在主设备SCK的控制下，待传数据由各自设备的数据寄存器传输到移位寄存器，再通过MOSI和MISO信号线完成主从设备间的数据交换。

![spi框图](/images/spi/spi_ms_mod_reg.png)

## 传输模式

SPI有4种操作模式，每种模式由一对参数决定，主从设备必须使用相同的工作参数，才能正常工作。

CPOL，时钟极性(clock polarity)，决定时钟空闲时的电平为高或低。对于SPI数据传输格式没有显著影响。

* 1 : 时钟低电平时有效，空闲时为高。
* 0 : 时钟高电平时有效，空闲时为低。

CPHA，时钟相位(clock phase)，定义时钟脉冲在哪条边沿转换输出信号，哪条边沿采样输入信号。

* 1 : 数据采样发生在时钟偶数边沿。
* 0 : 数据采样发生在时钟奇数边沿。

| 模式 | 状态 |
| ------ | -------------------------------  |
| Mode 0 | SCLK 空闲是为低电平，数据在上升沿有效 |
| Mode 1 | SCLK 空闲是为低电平，数据在下降沿有效 |
| Mode 2 | SCLK 空闲是为高电平，数据在下降沿有效 |
| Mode 3 | SCLK 空闲是为高电平，数据在上升沿有效 |

![4种模式](/images/spi/4mode.png)

![时序](/images/spi/timing_diagram.png)

### 时序要求

具体时序要求参考器件手册。以下Motorola标准对CPHA = 0和CPHA =1不同设置时序的简要说明：

* **CPHA = 0**

* 有些器件在片选后数据立即出现在MOSI/MISO管脚，数据锁存于第一个时钟边沿。
* 片选SS先于SCK半个时钟有效。
* 在SCK的第二个时钟边沿，上个时钟边沿锁存的数据写入移位寄存器（MSB或LSB）。
* 以此类推，数据在奇数边沿锁存，在偶数边沿写入移位寄存器。
* 经过16个时钟边沿后，串行传输的数据全部写入移位寄存器，完成主从设备的数据交换。

![CPHA = 0时序](/images/spi/spi_cpha_0.png)

* **CPHA = 1**

* 有些设备要求数据输出在SCK第一个时钟边沿之后，数据锁存于第二个时钟边沿。
* 片选SS先于SCK半个时钟有效。
* 在SCK的第三个时钟边沿，上个时钟边沿锁存的数据写入移位寄存器（MSB或LSB）。
* 以此类推，数据在偶数边沿锁存，在奇数边沿写入移位寄存器。
* 经过16个时钟边沿后，串行传输的数据全部写入移位寄存器，完成主从设备的数据交换。

![CPHA = 1时序](/images/spi/spi_cpha_1.png)

## 多个从设备

* **片选方式**

每个从设备都需要单独的片选信号，主设备每次只能选择其中一个从设备进行通信。因为所有从设备的SCK、MOSI、MISO都是连在一起的，未被选中从设备的MISO要表现为高阻状态以避免数据传输错误。由于每个设备都需要单独的片选信号，如果需要的片选信号过多，可以使用译码器产生所有的片选信号。

![主设备以片选方式控制多个从设备](/images/spi/multiple-slaves.png)
![主设备以片选方式控制多个从设备](/images/spi/multiple-slaves.png)

* **菊花链方式**

数据信号经过主从设备所有的移位寄存器构成闭环。数据通过主设备发送（绿色线）经过从设备返回（蓝色线）到主设备。在这种方式下，片选和时钟同时接到所有从设备。

菊花链式连接常用于仅需主设备发送数据而不需要接收返回数据的场合，如LED驱动器。在这种应用下，主设备MISO可以不连。如果需要接收从设备的返回数据，则需要连接主设备的MISO形成闭环。同样地，切记要发送足够多的接收指令以确保数据移位送达主设备。

![主设备以菊花链方式控制多个从设备](/images/spi/multiple-slaves2.png)
![主设备以菊花链方式控制多个从设备](/images/spi/multiple-slaves2.png)
