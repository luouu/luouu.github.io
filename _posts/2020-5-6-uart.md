---
layout: post
title: 串口
categories: [uart]
description: 
keywords: 
topmost: false
---

* TOC
{:toc}

**TTL电平：**

TTL是Transistor-Transistor Logic，即晶体管-晶体管逻辑的简称，数字电路中规定：

* 输出高电平>=2.4V，输出低电平<=0.4V；
* 输入高电平>=2.0V，输入低电平<=0.8V。
* 噪声容限是0.4V。

## RS232

RS232是串口的一个标准，RS232是负逻辑电平，它定义+5\~+12V为低电平，而-12\~-5V为高电平

![img](/images/uart/com.webp)

* 最大传输距离标准值为 50 米，实际上也只能用在 15 米左右。

* 传输速率较低，在异步传输时，波特率为 20Kbps。

* 只允许一对一通信。

## RS485

RS-232接口可以实现点对点的通信方式，但这种方式不能实现联网功能。于是，一个新的标准RS-485产生了。RS-485的数据信号采用差分传输方式，使用一对双绞线。由于是差分通信，因此接收数据和发送数据是不能同时进行的，只能工作在半双工模式，常用于总线网。

* 电气特性：逻辑1以两线间的电压差为+2\~6V表示；逻辑0以两线间的电压差为-2\~6V表示。

* 最大的通信距离约为1200米（9600bps 时），实际上可达 3000 米。

* 最大传输速率为10Mb/s。

* RS-485总线一般最大支持32个节点。

![MAX485](/images/uart/max485.png)

为了提高RS485的抗干扰性能，需要在靠近MAX485的AB引脚之间并接一个100 ~ 1K的电阻。

## RS422

RS-422（EIA RS-422-A Standard）是Apple的Macintosh计算机的串口连接标准。有4根信号线，两根发送、两根接收。由于RS-422 的收与发是分开的所以可以同时收和发（全双工），所以RS-422适用于两个站之间通信，星型网、环网，不可用于总线网。

* 最大传输距离为1219米，最大传输速率为10Mb/s。

* 最多可接10个节点。

* 支持点对多的双向通信。

![RS-xxx](/images/uart/RS-xxx.webp)

## 校验方式

串口通信过程中有五种校验方式：奇校验(ODD)、偶校验(EVEN)，1校验(MARK) 、 0校验(SPACE)，无校验(NONE)。

奇校验（odd parity）：让传输的数据（包含校验位）中1的个数为奇数。即：如果传输字节中1的个数是偶数，则校验位为“1”，奇数相反。

偶校验（even parity）：让传输的数据（包含校验位）中1的个数为偶数。即：如果传输字节中1的个数是偶数，则校验位为“0”，奇数相反。

数据和校验位发送给接受方后，接收方再次对数据中1的个数进行计算，如果为奇数则校验通过，表示此次传输过程未发生错误。如果不是奇数，则表示有错误发生，此时接收方可以向发送方发送请求，要求重新发送一遍数据。

* 偶校验(even parity): 数据位中1的个数是否是偶数个
* mark parity: 校验位始终为1
* space parity: 校验位始终为0

## modbus

Modbus协议是一种广泛应用于工业控制领域的通用通讯协议，使用的是主从通讯技术，即由主设备主动查询和操作从设备。Modbus通讯物理接口可以选用串口（包括RS232、RS485和RS422），也可以选择以太网口。

Modbus有三种通信方式：

* 以太网：对应的通信模式是MODBUS TCP/IP。
* 异步串行传输（各种介质如有线RS-232-/422/485/；光纤、无线等），对应的通信模式是MODBUS RTU或MODBUS ASCII。
* 高速令牌传递网络：对应的通信模式是Modbus PLUS

### ASCII模式

![Modbus帧结构-ASCII模式](/images/uart/Modbus-frame-structure-ASCII-mode.jpg)

在ASCII模式下，消息以冒号（:）字符（ASCII码 3AH）开始，以回车换行符结束（ASCII码 0DH,0AH）。其它域可以使用的传输字符是十六进制的0...9,A...F。网络上的设备不断侦测“:”字符，当有一个冒号接收到时，每个设备都解码地址域来判断是否发给自己的。消息中字符间发送的时间间隔最长不能超过1秒，否则接收的设备将认为传输错误。

错误检测域包含两个ASCII字符，使用LRC（纵向冗长检测）方法对消息内容计算得出的，不包括开始的冒号符及回车换行符。

### RTU模式

![RTU报文帧](/images/uart/RTU.bmp)

![](/images/uart/1.5T.jpg)

RTU模式规定消息发送至少要以3.5个字符时间的停顿间隔开始。至少3.5个字符时间的停顿标定了消息的结束。消息帧内字节间隔为1.5个字符时间。

从设备的地址范围是1~247，地址0是用作广播地址。主设备通过将要联络的从设备的地址放入消息中的地址域来选通从设备。当从设备发送回应消息时，它把自己的地址放入回应的地址域中，以便主设备知道是哪一个设备作出回应。

### 功能码

Modbus的操作对象有四种：线圈、离散输入、输入寄存器、保持寄存器。

| 对象       | 含义                                                         |
| ---------* | -----------------------------------------------------------* |
| 线圈       | 1bit，ON或OFF，可读可写，有效的地址范围是1-9999              |
| 离散量     | 1bit，ON或OFF，只读，有效地址范围是10001-19999               |
| 输入寄存器 | 16位的寄存器，只读，可以用作模拟量或16位打包输入点，有效地址范围是30001-39999 |
| 保持寄存器 | 16位的寄存器，可读可写，既可以是一个模拟量或16位打包输入点，也可以是模拟量或16位打包输出点，有效地址范围是40001-49999 |

Modbus的功能码有：

| 功能码 | 名称                    | 功能                                                         |
| -----* | ----------------------* | -----------------------------------------------------------* |
| 01     | 读线圈状态              | 读位（读N个bit）---读从机线圈寄存器，位操作                  |
| 02     | 读输入离散量            | 读位（读N个bit）---读离散输入寄存器，位操作                  |
| 03     | 读多个寄存器            | 读整型、字符型、状态字、浮点型（读N个words）---读保持寄存器，字节操作 |
| 04     | 读输入寄存器            | 读整型、状态字、浮点型（读N个words）---读输入寄存器，字节操作 |
| 05     | 写单个线圈              | 写位（写一个bit）---写线圈寄存器，位操作                     |
| 06     | 写单个保持寄存器        | 写整型、字符型、状态字、浮点型（写一个word）---写保持寄存器，字节操作 |
| 07     | 读取异常状态            | 取得8个内部线圈的通断状态，这8个线圈的地址由控制器决定，用户逻辑可以将这些线圈定义，以说明从机状态，短报文适宜于迅速读取状态 |
| 08     | 回送诊断校验            | 把诊断校验报文送从机，以对通信处理进行评鉴                   |
| 09     | 编程（只用于484）       | 使主机模拟编程器作用，修改PC从机逻辑                         |
| 0A     | 控询（只用于484）       | 可使主机与一台正在执行长程序任务从机通信，探询该从机是否已完成其操作任务，仅在含有功能码9的报文发送后，本功能码才发送 |
| 0B     | 读取事件计数            | 可使主机发出单询问，并随即判定操作是否成功，尤其是该命令或其他应答产生通信错误时 |
| 0C     | 读取通讯事件记录        | 可是主机检索每台从机的ModBus事务处理通信事件记录。如果某项事务处理完成，记录会给出有关错误 |
| 0D     | 编程（184/384/484/584） | 可使主机模拟编程器功能修改PC从机逻辑                         |
| 0E     | 探询（184/384/484/584） | 可使主机与正在执行任务的从机通信，定期控询该从机是否已完成其程序操作，仅在含有功能13的报文发送后，本功能码才得发送 |
| 0F     | 写多个线圈              | 可以写多个线圈---强置一串连续逻辑线圈的通断                  |
| 10     | 写多个保持寄存器        | 写多个保持寄存器---把具体的二进制值装入一串连续的保持寄存器  |
| 11     | 报告从机标识            | 可使主机判断编址从机的类型及该从机运行指示灯的状态           |
| 12     | （884和MICRO84）        | 可使主机模拟编程功能，修改PC状态逻辑                         |
| 13     | 重置通信链路            | 发生非可修改错误后，是从机复位于已知状态，可重置顺序字节     |
| 14     | 读取通用参数（584L）    | 显示扩展存储文件中的数据信息                                 |
| 15     | 写入通用参数（584L）    | 把通用参数写入扩展存储文件                                   |
| 16~40  | 保留做扩展功能备用      |                                                              |
| 41~48  | 保留以备用户功能所用    | 留作用户功能的扩展编码                                       |
| 49~77  | 非法功能                |                                                              |
| 78~7F  | 保留                    | 留作内部作用                                                 |
| 80~FF  | 保留                    | 用于异常应答                                                 |

常用功能码如下：

| 功能码 | 名称             | 功能                                                         | 对应的地址类型 |
| -----* | ---------------* | -----------------------------------------------------------* | -------------* |
| 01     | 读线圈状态       | 读位（读N个bit）---读从机线圈寄存器，位操作                  | 0x             |
| 02     | 读输入离散量     | 读位（读N个bit）---读离散输入寄存器，位操作                  | 1x             |
| 03     | 读多个寄存器     | 读整型、字符型、状态字、浮点型（读N个words）---读保持寄存器，字节操作 | 4X             |
| 04     | 读输入寄存器     | 读整型、状态字、浮点型（读N个words）---读输入寄存器，字节操作 | 3x             |
| 05     | 写单个线圈       | 写位（写一个bit）---写线圈寄存器，位操作                     | 0x             |
| 06     | 写单个保持寄存器 | 写整型、字符型、状态字、浮点型（写一个word）---写保持寄存器，字节操作 | 4x             |
| 0F     | 写多个线圈       | 写位（写n个bit）---强置一串连续逻辑线圈的通断                | 0x             |
| 10     | 写多个保持寄存器 | 写整形、字符型、状态字、浮点型（写n个word）---把具体的二进制值装入一串连续的保持寄存器 | 4x             |
